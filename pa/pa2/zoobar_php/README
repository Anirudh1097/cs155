README

CS155 Project 2, Part 2 -- Web Defenses

Diego Rafael Moreno Ferrer 
rmferrer@cs.stanford.edu
SUID#: 05490330


NOTE: I took the approach of doing all sanatization of user input up front. i.e. whenever I 
	  get HTTP request parameters that the application uses for SQL queries, to execute JS
	  or to reflect back to the user in some way I immediately sanatize upon arrival. I do not
	  do sanatization lazily where it happens at the moment of reflection/evaluation/storage.

	  In all of the files I have touched I have put all the untrusted data / HTTP request parameters
	  inside a /* UNTRUSTED DATA SANITIZATION */ section where all sanatizatio is done. 

NOTE: all instances of SQLi are neutralized by the following changes. The only user input that directly goes
	  into SQL queries are: usernames, session tokens, zoobars and profiles. The following changes: sanatize
	  usernames by forcing them to be alphanumeric, sanatizes session tokens by forcing them to be alphanumeric, 
	  sanatizes zoobars by casting user input to ints, sanatizes profiles by stripping all HTML tags and HTML encoding
	  them to encode all quotes and backslashes. 

NOTE: passwords do not need to be sanatized since they are neither reflected anywhere in the application and they are not
	  stored (only their hashes and a salt are stored but these are both generated by the applciation and they are safe since
	  they are alphanumeric)


Changes: 

0. Quoting HTML attributes and adding character encoding.

	Description: 
	- I've gone through all files and put quotes around all HTML attributes. 
	- I added a character encoding meta tag in the head section of all pages (in navigation.php) to avoid possibly exploitations
	  of unspecified character encodings. 

	These defenses by themselves do not beat any of the attacks but they are precautionary. 


1. Sanatizing zoobars and other ints

	Description: 
	I've gone through all places where the code expects an integer (zoobars, balances) and made an explicit cast to (int).
	
	Where: 
	I cast the zoobar POST parameter in transfer.php to an int before using it. Also I cast all the balance values
	retrieved from the DB to ints just to be safe. This happens when querying the DB for user balances in transfer.php, 
	in index.php, in users.php, and in zoobar.js.php.
	
	Vulnerabilities fixed: reflected XSS reflected vulnerabilities on transfer.php since when a transfer fails the zoobars
	are reflected in the zoobar field in the form.

	Changes in functionality: 
	No change in end user functionality.


2. Sanatizing usernames. 

	Description: 
	We force all usernames in the system to only contain alphanumeric characters plus the 
	characters "_" and "-".

	Where: 
	The main sanatization function "sanatize_username" is defined in includes/common.php. All places
	that receive usernames as HTTP request parameters call this function. This includes users.php, 
	login.php, and transfer.php.

	Vulnerabilities fixed: attack A (reflected XSS and SQLi versions) and attack E (along with the double quotes
	around the value attribute in the username input tag) are defeated. 

	Changes in functionality: 
	Users can no longer choose arbitary strings as usernames. Whenever a user tries to log in / register
	with an invalid name the system will display a message saying that usernames must contain alphanumeric
	chars. On every other instance where users input usernames (e.g. when searching for another user in 
	users.php) the system simply strips out the invalid characters. 


3. Removing eval from users.php

	Description: 
	Changed the eval call in users.php to a parseInt call since we expect to to read an int.

	Where: 
	The script element at the bottom of users.php 

	Vulnerabilities fixed: eval version of attack D (now injected javascript cannot be executed through this eval call)

	Changes in functionality: 
	No change in end user functionality.


4. CSRF protection for transfer.php

	Description: 
	Added a secret hidden token to the transfer form. The secret token is the md5 hash of the user's cookie value.
	Now attackers will not be able to do CSRF for transfers since they dont have the secret token and they can't guess it since
	they need to know the users cookie. I also added code so that if a request to transfer.php is made without the
	secret token then the server won't prefill the values of the form from the users input. This makes clickjacking
	harder since the attacker will have to make the user enter all fields of the form, not just hit the send button.

	Where: 
	In the form in transfer.php

	Vulnerabilities fixed: attack B and makes attack C (clickjacking) harder. 

	Changes in functionality: 
	No change in end user functionality. Just cannot make state changing POST requests to transfer without having them
	originate form the site.

5. Framebusting

	Description: 
	Added 'X-Frame-Options: DENY' HTTP header for all pages. This options when received by Firefox and Chrome will 
	tell the browser to not render a page if it is inside a frame. This will apply to all pages in 
	the site. 

	Where: 
	In includes/common.php

	Vulnerabilities fixed: attack C, and made the framing versions of attacks A and B harder. 

	Changes in functionality: 
	No site can frame content from zoobar. 


6. Sanatizing profiles.

	Description:
	All HTML markup is disallowed in profiles. HTML markup in profiles is stripped when POSTing profiles 
	and profile is HTML encoded (including backslashes) to avoid SQLi in the SQL which updates profiles.
	Custom markup introduced so that users can still have some markup in their profiles.  

	To prevent malicious profiles I have gotten rid of the old blacklist model and introduced a whitelist
	approach. 

	Profiles are not allowed to have any HTML tags. When receiving a user profile to be saved, the
	system will first strip all HTML tags. If users want to add markup to their profiles they
	have to do so throgh a custom markup specific to the application. The markup is simmple: it is almost
	identical to HTML, except that start and closing tags are delimited by the '#*' characters instead of '<' 
	and the '*#' characters instead of '>'. So for example to create the HTML equivalent of 
	'<b>Hello</b> world<br/>' the user would have to input '#*b*# Hello #*/b*# world #*br/*#.' 
	No HTML tag attributes are allowed. The only tags allowed are 'br', 'b', 'h1', 'h2', 'h3', 'h4', 
	'i', 'li', 'ol', 'p', 'strong', 'table', 'tr', 'td', 'th', 'u', 'ul', 'em', 'span'. 

	After stripping all HTML tags the user html encodes the profile to avoid SQLi (possible if we did not
	encode quotes or backslashes) and stores it in the DB. 

	When reflecting back the profile to the user is html decoded and all the custom markup is converted to the
	equivalent HTML markup. 
	
	Where: 
	The main sanatization functions are sanatize_profile and prepare_profile_for_output located in 
	includes/common.php. sanatize_profile is called in index.php before doing the SQL query to update
	the users profile. prepare_profile_for_output is called in users.php before reflecting the 
	profile to the user. 
	
	Vulnerabilities fixed: attack D. stored XSS is now impossible.

	Changes in functionality: 
	Users cannot use arbitrary markup in their profiles. If they want to markup their profiles they have to
	use the custom markup defined above. This markup is slightly more restricted than the previous one since
	it does not allow tag attributes and tags such as a and img are disallowed. 


Other minor changes:

7. Sanatizing cookie data
  	
  	Description: 
	I've sanatized session tokens in auth.php _checkRemembered. Session tokens are supposed to be alphanumeric 
	since they are md5 hashes. I remove all nonalphanumeric characters. This is just a sanity check. 

	Where: 
	In auth.php _checkRemembered. 

	Vulnerabilities fixed: SQLi in _checkRemembered done by messing with the cookie values and putting malicious 
	SQL in the token.

	Changes in functionality: 
	No changes in site functionality.


8. CSRF protection in all forms

	Description: 
	Added a secret hidden token to the profile update form. The secret token is the md5 hash of the user's cookie value.
	Now attackers will not be able to do CSRF for profile forms. 

	Where: 
	In the form in index.php

	Vulnerabilities fixed: CSRF for profiles.

	Changes in functionality: 
	No change in end user functionality. Just cannot make state changing POST requests to profile without having them
	originate form the site.


9. CSRF protection for logout
	